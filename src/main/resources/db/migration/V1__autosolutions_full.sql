-- V1__autosolutions_full.sql
-- Esquema completo y consistente con el dump actual (Oracle 21c XE)
-- Autor: Gerson / AutoSolutions

--------------------------------------------------------------------------------
-- 1) SCHEMA CONTEXT (ajusta si no usas el esquema GERSON)
--------------------------------------------------------------------------------
ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD';
ALTER SESSION SET NLS_TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS.FF6';

BEGIN
  EXECUTE IMMEDIATE 'CREATE USER GERSON IDENTIFIED BY "Catolica10" DEFAULT TABLESPACE USERS QUOTA UNLIMITED ON USERS';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -01920 AND SQLCODE != -01921 AND SQLCODE != -01918 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'GRANT CONNECT, RESOURCE TO GERSON';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

ALTER SESSION SET CURRENT_SCHEMA = GERSON;

--------------------------------------------------------------------------------
-- 2) SECUENCIAS (para todas las tablas con ID NUMBER(10,0), salvo identidades)
--------------------------------------------------------------------------------
CREATE SEQUENCE CLIENTE_SEQ        MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE VEHICULO_SEQ       MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE EMPLEADO_SEQ       MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE ORDEN_TRABAJO_SEQ  MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE DETALLE_ORDEN_SEQ  MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE PAGO_SEQ           MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE SERVICIO_SEQ       MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE REPUESTO_SEQ       MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE USUARIO_SEQ        MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;
CREATE SEQUENCE ROL_SEQ            MINVALUE 1 INCREMENT BY 1 START WITH 1 NOCACHE;

--------------------------------------------------------------------------------
-- 3) TABLAS (columnas y defaults según tu dump)
--------------------------------------------------------------------------------

-- CLIENTE
CREATE TABLE CLIENTE (
  ID          NUMBER(10,0)        NOT NULL,
  NOMBRES     VARCHAR2(100),
  APELLIDOS   VARCHAR2(100),
  TELEFONO    VARCHAR2(20),
  EMAIL       VARCHAR2(120),
  DIRECCION   VARCHAR2(200),
  DUI         VARCHAR2(20),
  ACTIVO      NUMBER(1,0) DEFAULT 1,
  VERSION     NUMBER(19,0),
  CREATED_AT  TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT  TIMESTAMP(6)
) TABLESPACE USERS;

-- VEHICULO
CREATE TABLE VEHICULO (
  ID          NUMBER(10,0) NOT NULL,
  CLIENTE_ID  NUMBER(10,0),
  PLACA       VARCHAR2(15),
  MARCA       VARCHAR2(50),
  MODELO      VARCHAR2(50),
  ANIO        NUMBER(4,0),
  COLOR       VARCHAR2(30),
  VIN         VARCHAR2(30),
  MARCA_ID    NUMBER,
  MODELO_ID   NUMBER,
  VERSION     NUMBER(19,0),
  CREATED_AT  TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT  TIMESTAMP(6)
) TABLESPACE USERS;

-- EMPLEADO
CREATE TABLE EMPLEADO (
  ID             NUMBER(10,0) NOT NULL,
  NOMBRE         VARCHAR2(100),
  APELLIDO       VARCHAR2(100),
  TELEFONO       VARCHAR2(20),
  EMAIL          VARCHAR2(120),
  ESPECIALIDAD   VARCHAR2(80),
  ACTIVO         NUMBER(1,0) DEFAULT 1,
  FECHA_INGRESO  DATE DEFAULT SYSDATE,
  ROL_ID         NUMBER(10,0),
  CREATED_AT     TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT     TIMESTAMP(6)
) TABLESPACE USERS;

COMMENT ON TABLE EMPLEADO IS 'Empleados/Mecánicos del taller';
COMMENT ON COLUMN EMPLEADO.ESPECIALIDAD IS 'Área de especialización del empleado';
COMMENT ON COLUMN EMPLEADO.ACTIVO      IS '1=Activo, 0=Inactivo';

-- ESTADO_ORDEN
CREATE TABLE ESTADO_ORDEN (
  ID          NUMBER(3,0) NOT NULL,
  NOMBRE      VARCHAR2(30),
  CREATED_AT  TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT  TIMESTAMP(6)
) TABLESPACE USERS;

-- ORDEN_TRABAJO
CREATE TABLE ORDEN_TRABAJO (
  ID                     NUMBER(10,0) NOT NULL,
  VEHICULO_ID            NUMBER(10,0),
  ESTADO_ID              NUMBER(3,0),
  FECHA_INGRESO          TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  FECHA_SALIDA           TIMESTAMP(6),
  FECHA_SALIDA_ESTIMADA  TIMESTAMP(6),
  KM_INGRESO             NUMBER(10,0),
  DIAGNOSTICO            VARCHAR2(1000),
  OBSERVACIONES          VARCHAR2(1000),
  SUBTOTAL_MANO_OBRA     NUMBER(19,4) DEFAULT 0,
  SUBTOTAL_REPUESTOS     NUMBER(19,4) DEFAULT 0,
  DESCUENTO              NUMBER(19,4) DEFAULT 0,
  IMPUESTO               NUMBER(19,4) DEFAULT 0,
  TOTAL                  NUMBER(19,4) DEFAULT 0,
  EMPLEADO_ID            NUMBER(10,0),
  VERSION                NUMBER(19,0) DEFAULT 0,
  CREATED_AT             TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT             TIMESTAMP(6)
) TABLESPACE USERS;

COMMENT ON COLUMN ORDEN_TRABAJO.EMPLEADO_ID IS 'Mecánico asignado a la orden (opcional)';

-- DETALLE_ORDEN
CREATE TABLE DETALLE_ORDEN (
  ID           NUMBER(10,0) NOT NULL,
  ORDEN_ID     NUMBER(10,0),
  TIPO         VARCHAR2(1),         -- 'S' Servicio, 'R' Repuesto
  SERVICIO_ID  NUMBER(10,0),
  REPUESTO_ID  NUMBER(10,0),
  DESCRIPCION  VARCHAR2(300),
  CANTIDAD     NUMBER(10,2) DEFAULT 1,
  PRECIO_UNIT  NUMBER(19,4) DEFAULT 0,
  TOTAL_LINEA  NUMBER(19,4) DEFAULT 0,
  CREATED_AT   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT   TIMESTAMP(6)
) TABLESPACE USERS;

-- PAGO
CREATE TABLE PAGO (
  ID           NUMBER(10,0) NOT NULL,
  ORDEN_ID     NUMBER(10,0),
  FECHA_PAGO   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  MONTO        NUMBER(19,4),
  METODO       VARCHAR2(20),
  REFERENCIA   VARCHAR2(60),
  CREATED_AT   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT   TIMESTAMP(6)
) TABLESPACE USERS;

-- REPUESTO
CREATE TABLE REPUESTO (
  ID           NUMBER(10,0) NOT NULL,
  NOMBRE       VARCHAR2(120),
  PRECIO_UNIT  NUMBER(19,4) DEFAULT 0,
  STOCK        NUMBER(10,2) DEFAULT 0,
  ACTIVO       NUMBER(1,0)  DEFAULT 1,
  VERSION      NUMBER(19,0) DEFAULT 0,
  CREATED_AT   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT   TIMESTAMP(6)
) TABLESPACE USERS;

-- SERVICIO
CREATE TABLE SERVICIO (
  ID           NUMBER(10,0) NOT NULL,
  NOMBRE       VARCHAR2(100),
  PRECIO_UNIT  NUMBER(19,4) DEFAULT 0,
  ACTIVO       NUMBER(1,0)  DEFAULT 1,
  CREATED_AT   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT   TIMESTAMP(6)
) TABLESPACE USERS;

-- ROL
CREATE TABLE ROL (
  ID          NUMBER(10,0) NOT NULL,
  NOMBRE      VARCHAR2(40),
  CREATED_AT  TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT  TIMESTAMP(6)
) TABLESPACE USERS;

-- USUARIO (para login interno del taller si lo usas)
CREATE TABLE USUARIO (
  ID          NUMBER(10,0) NOT NULL,
  USERNAME    VARCHAR2(60),
  NOMBRE      VARCHAR2(100),
  PASS_HASH   VARCHAR2(255),
  ACTIVO      NUMBER(1,0) DEFAULT 1,
  CREATED_AT  TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  UPDATED_AT  TIMESTAMP(6)
) TABLESPACE USERS;

-- MARCA (IDENTITY según tu dump)
CREATE TABLE MARCA (
  ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
  NOMBRE  VARCHAR2(50)
) TABLESPACE USERS;

-- MODELO (IDENTITY según tu dump)
CREATE TABLE MODELO (
  ID        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
  MARCA_ID  NUMBER,
  NOMBRE    VARCHAR2(50)
) TABLESPACE USERS;

--------------------------------------------------------------------------------
-- 4) PRIMARY KEYS
--------------------------------------------------------------------------------
ALTER TABLE CLIENTE        ADD CONSTRAINT PK_CLIENTE        PRIMARY KEY (ID);
ALTER TABLE VEHICULO       ADD CONSTRAINT PK_VEHICULO       PRIMARY KEY (ID);
ALTER TABLE EMPLEADO       ADD CONSTRAINT PK_EMPLEADO       PRIMARY KEY (ID);
ALTER TABLE ESTADO_ORDEN   ADD CONSTRAINT PK_ESTADO_ORDEN   PRIMARY KEY (ID);
ALTER TABLE ORDEN_TRABAJO  ADD CONSTRAINT PK_ORDEN_TRABAJO  PRIMARY KEY (ID);
ALTER TABLE DETALLE_ORDEN  ADD CONSTRAINT PK_DETALLE_ORDEN  PRIMARY KEY (ID);
ALTER TABLE PAGO           ADD CONSTRAINT PK_PAGO           PRIMARY KEY (ID);
ALTER TABLE REPUESTO       ADD CONSTRAINT PK_REPUESTO       PRIMARY KEY (ID);
ALTER TABLE SERVICIO       ADD CONSTRAINT PK_SERVICIO       PRIMARY KEY (ID);
ALTER TABLE ROL            ADD CONSTRAINT PK_ROL            PRIMARY KEY (ID);
ALTER TABLE USUARIO        ADD CONSTRAINT PK_USUARIO        PRIMARY KEY (ID);
ALTER TABLE MARCA          ADD CONSTRAINT PK_MARCA          PRIMARY KEY (ID);
ALTER TABLE MODELO         ADD CONSTRAINT PK_MODELO         PRIMARY KEY (ID);

--------------------------------------------------------------------------------
-- 5) UNIQUE KEYS útiles en negocio
--------------------------------------------------------------------------------
ALTER TABLE ROL       ADD CONSTRAINT UQ_ROL_NOMBRE            UNIQUE (NOMBRE);
ALTER TABLE MARCA     ADD CONSTRAINT UQ_MARCA_NOMBRE          UNIQUE (NOMBRE);
ALTER TABLE MODELO    ADD CONSTRAINT UQ_MODELO_MARCA_NOMBRE   UNIQUE (MARCA_ID, NOMBRE);
ALTER TABLE USUARIO   ADD CONSTRAINT UQ_USUARIO_USERNAME      UNIQUE (USERNAME);
ALTER TABLE VEHICULO  ADD CONSTRAINT UQ_VEHICULO_PLACA        UNIQUE (PLACA);
ALTER TABLE CLIENTE   ADD CONSTRAINT UQ_CLIENTE_DUI           UNIQUE (DUI);

--------------------------------------------------------------------------------
-- 6) FOREIGN KEYS
--------------------------------------------------------------------------------
ALTER TABLE VEHICULO      ADD CONSTRAINT FK_VEHICULO_CLIENTE    FOREIGN KEY (CLIENTE_ID)  REFERENCES CLIENTE(ID);
ALTER TABLE VEHICULO      ADD CONSTRAINT FK_VEHICULO_MARCA      FOREIGN KEY (MARCA_ID)    REFERENCES MARCA(ID);
ALTER TABLE VEHICULO      ADD CONSTRAINT FK_VEHICULO_MODELO     FOREIGN KEY (MODELO_ID)   REFERENCES MODELO(ID);

ALTER TABLE EMPLEADO      ADD CONSTRAINT FK_EMPLEADO_ROL        FOREIGN KEY (ROL_ID)      REFERENCES ROL(ID);

ALTER TABLE ORDEN_TRABAJO ADD CONSTRAINT FK_ORDEN_VEHICULO      FOREIGN KEY (VEHICULO_ID) REFERENCES VEHICULO(ID);
ALTER TABLE ORDEN_TRABAJO ADD CONSTRAINT FK_ORDEN_ESTADO        FOREIGN KEY (ESTADO_ID)   REFERENCES ESTADO_ORDEN(ID);
ALTER TABLE ORDEN_TRABAJO ADD CONSTRAINT FK_ORDEN_EMPLEADO      FOREIGN KEY (EMPLEADO_ID) REFERENCES EMPLEADO(ID);

ALTER TABLE DETALLE_ORDEN ADD CONSTRAINT FK_DETALLE_ORDEN       FOREIGN KEY (ORDEN_ID)    REFERENCES ORDEN_TRABAJO(ID);
ALTER TABLE DETALLE_ORDEN ADD CONSTRAINT FK_DETALLE_SERVICIO    FOREIGN KEY (SERVICIO_ID) REFERENCES SERVICIO(ID);
ALTER TABLE DETALLE_ORDEN ADD CONSTRAINT FK_DETALLE_REPUESTO    FOREIGN KEY (REPUESTO_ID) REFERENCES REPUESTO(ID);

ALTER TABLE PAGO          ADD CONSTRAINT FK_PAGO_ORDEN          FOREIGN KEY (ORDEN_ID)    REFERENCES ORDEN_TRABAJO(ID);

--------------------------------------------------------------------------------
-- 7) CHECKS sencillos
--------------------------------------------------------------------------------
ALTER TABLE CLIENTE   ADD CONSTRAINT CK_CLIENTE_ACTIVO   CHECK (ACTIVO IN (0,1));
ALTER TABLE EMPLEADO  ADD CONSTRAINT CK_EMPLEADO_ACTIVO  CHECK (ACTIVO IN (0,1));
ALTER TABLE SERVICIO  ADD CONSTRAINT CK_SERVICIO_ACTIVO  CHECK (ACTIVO IN (0,1));
ALTER TABLE REPUESTO  ADD CONSTRAINT CK_REPUESTO_ACTIVO  CHECK (ACTIVO IN (0,1));
ALTER TABLE DETALLE_ORDEN ADD CONSTRAINT CK_DETALLE_TIPO CHECK (TIPO IN ('S','R'));

--------------------------------------------------------------------------------
-- 8) ÍNDICES (incluye el de fechas de órdenes)
--------------------------------------------------------------------------------
CREATE INDEX IX_ORDEN_TRABAJO_ESTADO     ON ORDEN_TRABAJO(ESTADO_ID);
CREATE INDEX IX_ORDEN_TRABAJO_FECHAS     ON ORDEN_TRABAJO(FECHA_INGRESO, FECHA_SALIDA, FECHA_SALIDA_ESTIMADA);
CREATE INDEX IX_DETALLE_ORDEN_ORDEN      ON DETALLE_ORDEN(ORDEN_ID);
CREATE INDEX IX_PAGO_ORDEN               ON PAGO(ORDEN_ID);
CREATE INDEX IX_VEHICULO_CLIENTE         ON VEHICULO(CLIENTE_ID);

--------------------------------------------------------------------------------
-- 9) TRIGGERS de AUTO-ID (sec->ID) y de UPDATED_AT (touch)
--------------------------------------------------------------------------------

-- Helper para crear trigger de secuencia
CREATE OR REPLACE PROCEDURE PRC_APPLY_SEQ(p_table VARCHAR2, p_col VARCHAR2, p_seq VARCHAR2) AS
  v_sql CLOB;
BEGIN
  v_sql := 'CREATE OR REPLACE TRIGGER BI_'||p_table||' '||
           'BEFORE INSERT ON '||p_table||' FOR EACH ROW '||
           'BEGIN IF :NEW.'||p_col||' IS NULL THEN SELECT '||p_seq||'.NEXTVAL INTO :NEW.'||p_col||' FROM DUAL; END IF; END;';
  EXECUTE IMMEDIATE v_sql;
END;
/

BEGIN
  PRC_APPLY_SEQ('CLIENTE','ID','CLIENTE_SEQ');
  PRC_APPLY_SEQ('VEHICULO','ID','VEHICULO_SEQ');
  PRC_APPLY_SEQ('EMPLEADO','ID','EMPLEADO_SEQ');
  PRC_APPLY_SEQ('ORDEN_TRABAJO','ID','ORDEN_TRABAJO_SEQ');
  PRC_APPLY_SEQ('DETALLE_ORDEN','ID','DETALLE_ORDEN_SEQ');
  PRC_APPLY_SEQ('PAGO','ID','PAGO_SEQ');
  PRC_APPLY_SEQ('SERVICIO','ID','SERVICIO_SEQ');
  PRC_APPLY_SEQ('REPUESTO','ID','REPUESTO_SEQ');
  PRC_APPLY_SEQ('USUARIO','ID','USUARIO_SEQ');
  PRC_APPLY_SEQ('ROL','ID','ROL_SEQ');
END;
/

-- Trigger genérico UPDATED_AT
CREATE OR REPLACE PROCEDURE PRC_TOUCH_UPDATED_AT(p_table VARCHAR2) AS
  v_sql CLOB;
BEGIN
  v_sql := 'CREATE OR REPLACE TRIGGER BU_'||p_table||'_UPDATED '||
           'BEFORE UPDATE ON '||p_table||' FOR EACH ROW '||
           'BEGIN :NEW.UPDATED_AT := SYSTIMESTAMP; END;';
  EXECUTE IMMEDIATE v_sql;
END;
/

BEGIN
  PRC_TOUCH_UPDATED_AT('CLIENTE');
  PRC_TOUCH_UPDATED_AT('VEHICULO');
  PRC_TOUCH_UPDATED_AT('EMPLEADO');
  PRC_TOUCH_UPDATED_AT('ESTADO_ORDEN');
  PRC_TOUCH_UPDATED_AT('ORDEN_TRABAJO');
  PRC_TOUCH_UPDATED_AT('DETALLE_ORDEN');
  PRC_TOUCH_UPDATED_AT('PAGO');
  PRC_TOUCH_UPDATED_AT('REPUESTO');
  PRC_TOUCH_UPDATED_AT('SERVICIO');
  PRC_TOUCH_UPDATED_AT('ROL');
  PRC_TOUCH_UPDATED_AT('USUARIO');
  PRC_TOUCH_UPDATED_AT('MARCA');
  PRC_TOUCH_UPDATED_AT('MODELO');
END;
/

--------------------------------------------------------------------------------
-- 10) SEED MÍNIMO NECESARIO PARA OPERAR
--------------------------------------------------------------------------------
-- ESTADOS
MERGE INTO ESTADO_ORDEN d USING (
  SELECT 1 ID, 'ABIERTA'     NOMBRE FROM DUAL UNION ALL
  SELECT 2,    'DIAGNOSTICO'        FROM DUAL UNION ALL
  SELECT 3,    'EN_PROCESO'         FROM DUAL UNION ALL
  SELECT 4,    'PARA_COBRO'         FROM DUAL UNION ALL
  SELECT 5,    'CERRADA'            FROM DUAL
) s ON (d.ID = s.ID)
WHEN NOT MATCHED THEN
  INSERT (ID, NOMBRE) VALUES (s.ID, s.NOMBRE);

-- ROLES
MERGE INTO ROL d USING (
  SELECT 1 ID, 'ADMIN'     NOMBRE FROM DUAL UNION ALL
  SELECT 2,    'RECEPCION'        FROM DUAL UNION ALL
  SELECT 3,    'MECANICO'         FROM DUAL UNION ALL
  SELECT 4,    'CAJA'             FROM DUAL
) s ON (d.ID = s.ID)
WHEN NOT MATCHED THEN
  INSERT (ID, NOMBRE) VALUES (s.ID, s.NOMBRE);

-- (Opcional) Usuario admin inicial: USERNAME=admin / PASS hash vacío (llénalo desde la app)
-- INSERT INTO USUARIO (ID, USERNAME, NOMBRE, PASS_HASH, ACTIVO) VALUES (USUARIO_SEQ.NEXTVAL, 'admin', 'Administrador', '{bcrypt-aqui}', 1);

--------------------------------------------------------------------------------
-- FIN DE V1
--------------------------------------------------------------------------------
